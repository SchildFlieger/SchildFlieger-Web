<!DOCTYPE html>
<html>
  <head>
    <title>Like Debug Test</title>
    <style>
      .like-button {
        background: #333;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        margin: 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .like-button.liked {
        color: red;
      }

      @keyframes likePulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }

      .like-button.liked-animation {
        animation: likePulse 0.5s ease;
      }
    </style>
  </head>
  <body>
    <h1>Like Debug Test</h1>
    <button class="like-button" data-filename="Amena Tom.mp4">
      <span class="heart">❤️</span> <span class="like-count">0</span>
    </button>
    <div id="result"></div>
    <button id="refreshBtn">Refresh Likes</button>

    <script>
      let likes = {};

      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded");

        const likeButton = document.querySelector(".like-button");
        const resultDiv = document.getElementById("result");
        const refreshBtn = document.getElementById("refreshBtn");

        if (likeButton) {
          console.log("Like button found");

          // Load initial likes
          loadLikes();

          likeButton.addEventListener("click", function () {
            const filename = this.getAttribute("data-filename");
            console.log("Like button clicked for:", filename);
            likeMedia(filename, this);
          });
        } else {
          console.log("Like button not found");
          resultDiv.innerHTML = "Like button not found";
        }

        if (refreshBtn) {
          refreshBtn.addEventListener("click", function () {
            loadLikes();
          });
        }
      });

      function loadLikes() {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "Loading likes...";

        fetch("/secret/Tom/get_likes.php")
          .then((response) => {
            console.log("Load likes - Response status:", response.status);
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Load likes - Data received:", data);
            resultDiv.innerHTML = "Likes loaded: " + JSON.stringify(data);

            if (data.success) {
              likes = data.likes;
              updateLikeCount();
            }
          })
          .catch((error) => {
            console.error("Load likes - Error:", error);
            resultDiv.innerHTML = "Error loading likes: " + error.message;
          });
      }

      function likeMedia(filename, button) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "Liking " + filename + "...";

        fetch("/secret/Tom/like_handler.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ filename: filename }),
        })
          .then((response) => {
            console.log("Like - Response status:", response.status);
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Like - Data received:", data);
            resultDiv.innerHTML = "Like response: " + JSON.stringify(data);

            if (data.success) {
              likes[filename] = data.like_count;
              updateLikeCount();

              // Visual feedback
              button.classList.add("liked");
              button.classList.add("liked-animation");
              setTimeout(() => {
                button.classList.remove("liked-animation");
              }, 500);
            }
          })
          .catch((error) => {
            console.error("Like - Error:", error);
            resultDiv.innerHTML = "Error liking: " + error.message;
          });
      }

      function updateLikeCount() {
        const likeButton = document.querySelector(".like-button");
        const filename = likeButton.getAttribute("data-filename");
        const likeCountElement = likeButton.querySelector(".like-count");

        const count = likes[filename] || 0;
        if (likeCountElement) {
          likeCountElement.textContent = count;
        }

        console.log("Updated like count for", filename, "to", count);
      }
    </script>
  </body>
</html>
